<script lang="ts">
    import { goto } from '$app/navigation';
    import { page } from '$app/stores';
    import { Alert, CardGrid, PaginationInline } from '$lib/components';
    import { Button } from '$lib/elements/forms';
    import { sdk } from '$lib/stores/sdk';
    import type { Models } from '@appwrite.io/console';
    import GitInstallationModal from './GitInstallationModal.svelte';
    import GitDisconnectModal from './GitDisconnectModal.svelte';
    import dayjs from 'dayjs';
    import { isSelfHosted } from '$lib/system';
    import { consoleVariables } from '$routes/(console)/store';
    import {
        ActionMenu,
        Card,
        Empty,
        Icon,
        Layout,
        Popover,
        Table
    } from '@appwrite.io/pink-svelte';
    import {
        IconExternalLink,
        IconGithub,
        IconPlus,
        IconXCircle
    } from '@appwrite.io/pink-icons-svelte';

    export let total: number;
    export let limit: number;
    export let offset: number;
    export let installations: Models.Installation[];

    let showGitIstall = false;
    let showGitDisconnect = false;
    let showInstallationDropdown: boolean[] = [];
    let selectedInstallation: Models.Installation;
    const isVcsEnabled = $consoleVariables?._APP_VCS_ENABLED === true;

    function getInstallationLink(installation: Models.Installation) {
        switch (installation.provider) {
            case 'github':
                return `https://github.com/${installation.organization}`;
            default:
                return '';
        }
    }

    function getProviderIcon(provider: string): string {
        switch (provider) {
            case 'github':
                return 'icon-github';
            default:
                return '';
        }
    }

    function configureGitHub() {
        const redirect = new URL($page.url);
        redirect.searchParams.append('alert', 'installation-updated');
        const target = new URL(`${sdk.forProject.client.config.endpoint}/vcs/github/authorize`);
        target.searchParams.set('project', $page.params.project);
        target.searchParams.set('success', redirect.toString());
        target.searchParams.set('failure', redirect.toString());
        target.searchParams.set('mode', 'admin');
        return target?.toString();
    }

    async function navigateInstallations() {
        const next = new URL($page.url);
        next.searchParams.set('offset', offset.toString());
        await goto(next, {
            noScroll: true
        });
    }
</script>

<CardGrid>
    <svelte:fragment slot="title">Git configuration</svelte:fragment>
    Add a Git installation to your project. You can connect a repository in your function settings.
    <svelte:fragment slot="aside">
        {#if total > 0}
            <div>
                <div class="u-flex u-flex-vertical-mobile u-main-end u-padding-block-end-16">
                    <ul class="buttons-list">
                        <li class="buttons-list-item">
                            <Button secondary on:click={() => (showGitIstall = true)}>
                                <Icon icon={IconPlus} slot="start" size="s" />
                                Add installation
                            </Button>
                        </li>
                    </ul>
                </div>

                <Table.Root>
                    <svelte:fragment slot="header">
                        <Table.Header.Cell>Repository</Table.Header.Cell>
                        <Table.Header.Cell>Updated</Table.Header.Cell>
                        <Table.Header.Cell width="20px" />
                    </svelte:fragment>
                    {#each installations as installation, i}
                        <Table.Row>
                            <Table.Cell>
                                <div class="u-flex u-gap-8 u-cross-center">
                                    <div class="avatar is-size-small">
                                        <span
                                            class={getProviderIcon(installation.provider)}
                                            style="font-size: var(--icon-size-medium)!important" />
                                    </div>
                                    <a
                                        href={getInstallationLink(installation)}
                                        target="_blank"
                                        class="u-flex u-gap-4 u-cross-center">
                                        <span>{installation.organization}</span><span
                                            style="font-size: 1rem; color: hsl(var(--color-neutral-70));"
                                            class="icon-external-link" /></a>
                                </div>
                            </Table.Cell>
                            <Table.Cell>
                                {dayjs().to(installation.$updatedAt)}
                            </Table.Cell>
                            <Table.Cell>
                                <Popover let:toggle padding="none" placement="bottom-end">
                                    <button
                                        type="button"
                                        class="button is-text is-only-icon"
                                        aria-label="more options"
                                        on:click={toggle}>
                                        <span class="icon-dots-horizontal" aria-hidden="true" />
                                    </button>
                                    <ActionMenu.Root slot="tooltip">
                                        <ActionMenu.Item.Anchor
                                            href={configureGitHub()}
                                            trailingIcon={IconExternalLink}
                                            on:click={() => (showInstallationDropdown[i] = false)}>
                                            Configure
                                        </ActionMenu.Item.Anchor>
                                        <ActionMenu.Item.Button
                                            trailingIcon={IconXCircle}
                                            on:click={() => {
                                                showInstallationDropdown[i] = false;
                                                showGitDisconnect = true;
                                                selectedInstallation = installation;
                                            }}>
                                            Disconnect
                                        </ActionMenu.Item.Button>
                                    </ActionMenu.Root>
                                </Popover>
                            </Table.Cell>
                        </Table.Row>
                    {/each}
                </Table.Root>
            </div>
            {#if total > limit}
                <Layout.Stack justifyContent="space-between">
                    <p class="text">Total installations: {total}</p>
                    <PaginationInline
                        {limit}
                        sum={total}
                        on:change={navigateInstallations}
                        bind:offset />
                </Layout.Stack>
            {/if}
        {:else if isSelfHosted && !isVcsEnabled}
            <Alert type="info">
                <svelte:fragment slot="title">
                    Installing Git to a self-hosted instance
                </svelte:fragment>
                Before installing Git in a locally hosted Appwrite project, ensure your environment variables
                are configured.
            </Alert>
        {/if}
        <Card.Base padding="none" border="dashed">
            <Empty
                type="secondary"
                title="No installation was added to the project yet"
                description="Add an installation to connect repositories">
                <svelte:fragment slot="actions">
                    <Button secondary href={configureGitHub()} external>
                        <Icon icon={IconGithub} size="s" slot="start" />
                        Add installation
                    </Button>
                </svelte:fragment>
            </Empty>
        </Card.Base>
    </svelte:fragment>
</CardGrid>

{#if showGitIstall}
    <GitInstallationModal bind:showGitInstall={showGitIstall} />
{/if}

{#if showGitDisconnect}
    <GitDisconnectModal bind:showGitDisconnect {selectedInstallation} />
{/if}
