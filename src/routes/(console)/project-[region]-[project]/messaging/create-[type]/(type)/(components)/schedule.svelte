<script lang="ts">
    import { Button, InputDate, InputSelect, InputTime } from '$lib/elements/forms';
    import Helper from '$lib/elements/forms/helper.svelte';
    import { isSameDay, toLocaleDateISO, toLocaleTimeISO } from '$lib/helpers/date';
    import { wizard } from '$lib/stores/wizard';
    import { Modal } from '$lib/components';
    import { Layout } from '@appwrite.io/pink-svelte';

    export let targets: string[];
    export let scheduledAt: string;

    let when: 'now' | 'later' = 'now';
    let now = new Date();
    let minDate: string;
    let date: string;
    let time: string;
    let dateTime: Date;
    let showConfirmation = false;

    let totalTargets = targets?.length ?? 0;

    const options = [
        { label: 'Now', value: 'now' },
        { label: 'Custom', value: 'later' }
    ];

    const dateOptions: Intl.DateTimeFormatOptions = {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
    };
    const timeOptions: Intl.DateTimeFormatOptions = {
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hourCycle: 'h23',
        timeZoneName: 'longGeneric'
    };

    async function submit() {
        $wizard.interceptorNotificationEnabled = true;
        await $wizard.finalAction();
        showConfirmation = false;
    }

    $: if (when === 'now') {
        date = time = '';
    }
    $: if (when === 'later') {
        now = new Date();
    }
    $: minDate = toLocaleDateISO(now.getTime());
    $: minTime = isSameDay(new Date(date), new Date(minDate))
        ? toLocaleTimeISO(now.getTime())
        : '00:00';
    $: dateTime = new Date(`${date}T${time}`);
    $: if (!isNaN(dateTime.getTime())) {
        scheduledAt = dateTime.toISOString();
    }
</script>

<Layout.Stack>
    <InputSelect id="when" label="Schedule" required {options} bind:value={when} />
    {#if when === 'later'}
        <Layout.Stack direction="row" gap="m">
            <InputDate id="date" min={minDate} bind:value={date} required />
            <InputTime id="time" min={minTime} bind:value={time} required />
        </Layout.Stack>
    {/if}
    <Helper type="neutral">
        {#if when === 'now'}
            The message will be sent immediately
        {:else if !dateTime || isNaN(dateTime.getTime())}
            The message will be sent later
        {:else}
            The message will be sent on {dateTime.toLocaleDateString('en', dateOptions)} at {dateTime.toLocaleTimeString(
                'en',
                timeOptions
            )}
        {/if}
    </Helper>
</Layout.Stack>
{#if showConfirmation}
    <Modal title="Send message" bind:show={showConfirmation} onSubmit={submit}>
        <p>
            You are about to send a message to an estimated <span class="u-bold"
                >{totalTargets}</span> recipients. Would you like to proceed?
        </p>
        <p class="u-bold">This action is irreversible.</p>
        <svelte:fragment slot="footer">
            <Button text on:click={() => (showConfirmation = false)}>Cancel</Button>
            <Button secondary submit>Send</Button>
        </svelte:fragment>
    </Modal>
{/if}
