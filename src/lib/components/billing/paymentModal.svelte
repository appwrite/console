<script lang="ts">
    import { FakeModal } from '$lib/components';
    import { InputText, Button } from '$lib/elements/forms';
    import { createEventDispatcher, onMount } from 'svelte';
    import { initializeStripe, setPaymentMethod, submitStripeCard } from '$lib/stores/stripe';
    import { invalidate } from '$app/navigation';
    import { Dependencies } from '$lib/constants';
    import { addNotification } from '$lib/stores/notifications';
    import { page } from '$app/state';
    import { Spinner } from '@appwrite.io/pink-svelte';
    import type { PaymentMethod } from '@stripe/stripe-js';
    import StatePicker from './statePicker.svelte';

    export let show = false;

    const dispatch = createEventDispatcher();

    let name: string;
    let error: string;
    let modal: FakeModal;
    let showState: boolean = false;
    let state: string = '';
    let paymentMethod: PaymentMethod | null = null;

    async function handleSubmit() {
        try {
            if (showState && !state) {
                throw Error('Please select a state');
            }

            if (showState) {
                const card = await setPaymentMethod(paymentMethod.id, name, state);
                modal.closeModal();
                await invalidate(Dependencies.PAYMENT_METHODS);
                dispatch('submit', card);
                addNotification({
                    type: 'success',
                    message: 'A new payment method has been added to your account'
                });
                return;
            }

            const card = await submitStripeCard(name, page?.params?.organization ?? null);
            if (card && Object.hasOwn(card, 'id')) {
                if ((card as PaymentMethod).card?.country === 'US') {
                    paymentMethod = card as PaymentMethod;
                    showState = true;
                    return;
                }
            }
            modal.closeModal();
            await invalidate(Dependencies.PAYMENT_METHODS);
            dispatch('submit', card);
            addNotification({
                type: 'success',
                message: 'A new payment method has been added to your account'
            });
        } catch (e) {
            error = e.message;
        }
    }

    let isLoading = true;
    let element: HTMLElement;

    let observer: MutationObserver;

    onMount(() => {
        initializeStripe(element);
        observer = new MutationObserver((mutationsList) => {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    if (mutation.addedNodes.length > 0) {
                        for (let node of Array.from(mutation.addedNodes)) {
                            if (
                                node instanceof Element &&
                                node.className.toLowerCase().includes('__privatestripeelement')
                            ) {
                                isLoading = false;
                            }
                        }
                    }
                }
            }
        });

        return () => {
            observer.disconnect();
        };
    });

    $: if (element) {
        observer.observe(element, { childList: true });
    }
</script>

<FakeModal
    bind:this={modal}
    bind:show
    title="Add payment method"
    bind:error
    onSubmit={handleSubmit}>
    <slot />
    {#if showState}
        <StatePicker card={paymentMethod} bind:state />
    {:else}
        <InputText
            id="name"
            required
            autofocus={true}
            bind:value={name}
            label="Cardholder name"
            placeholder="Cardholder name" />
        <div class="aw-stripe-container" data-private>
            {#if isLoading}
                <div class="loader-element">
                    <Spinner />
                </div>
            {/if}
            <div
                style:display={isLoading ? 'none' : 'initial'}
                class="stripe-element"
                bind:this={element}>
                <!-- Stripe will create form elements here -->
            </div>
        </div>
    {/if}
    <slot name="end"></slot>
    <svelte:fragment slot="footer">
        <Button secondary on:click={() => (show = false)}>Cancel</Button>
        <Button submit disabled={!name}>Add</Button>
    </svelte:fragment>
</FakeModal>

<style lang="scss">
    .aw-stripe-container {
        display: flex;
        min-height: 245px;

        .stripe-element {
            width: 100%;
        }

        .loader-element {
            width: 100%;
            align-self: center;
            justify-content: center;
            display: flex;
        }
    }
</style>
